<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">

	<head>
		<meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
		<meta name="viewport" content="width=device-width" />
		<meta name="viewport" content="initial-scale=1.0,user-scalable=no" />
		<meta name="apple-mobile-web-app-capable" content="yes">
		<meta name="apple-mobile-web-app-status-bar-style" content="black">
		<link rel="stylesheet" href="../../../css/mui.min.css" />
		<link rel="stylesheet" type="text/css" href="../../../css/common.css" />
		<link rel="stylesheet" type="text/css" href="../../../css/insur_card_info.css" />
		<title>卡单详情</title>
		<style type="text/css">
			.hong{padding-top: 8px;}
			.huang{padding-top: 8px;}
			
			#textinfo{
				padding-left: 5%;
			}
			#textinfo ul li{
			    list-style-type: disc;
			}
			
			#textinfo ol{
				
			}
			#textinfo ul ul li{
				list-style-type:none;
			}
		</style>
	</head>

	<body style="background:#f4f4f4;">
		<header class="mui-bar mui-bar-nav">
			<a class="mui-action-back mui-icon mui-icon-left-nav mui-pull-left"></a>
			<h1 class="mui-title">卡单详情</h1>
		</header>

		<div class="mui-content">
			<div class="content" id="card_body">
				<section class="all on">
					<form action="" class="mui-card-table" id="cardInfoList">
					</form>
				</section>
			</div>
			
			<div style="width:100%; height:60px;"></div>
			<div class="doot">
				<div class="doot-left">
					<button type="button" class="mui-btn mui-btn-yellow huang" id="addtoCart">加入购物车</button>
				</div>
				<div class="doot-right">
					<button type="button" class="mui-btn mui-btn-red hong" id="buying">立即购买</button>
				</div>
			</div>
			<div style="clear:both;"></div>
		</div>
		
		<!------------------------------------------------------------------------------------------------------>
		<script type="text/html" id="cardInfoTmpl">
			{{each result as value i}}
				<img src="{{value.img_big}}" width="100%" />
				<div class="xmain" data-id="{{value.id}}" id="idInfo">
					<h2>{{value.name}}</h2>
					<h3>{{value.description}}</h3>
					<div class="bt">
						<div class="bt-left">参考价：<strong>￥{{value.price}}</strong></div>
						<div style="clear:both;"></div>
					</div>
					<div class="yf">
						<div class="yf-left">送至：江苏省 &nbsp;&nbsp;</div>
						<div class="yf-right"><img src="../../../images/goods/insur_card/jj.png" width="25" /></div>
						<div style="clear:both;"></div>
					</div>
				</div>
				<div class="xmain" style="display: none;">
					<div class="baoz"><strong>售后保障</strong>
						<p>卖家承诺以下服务</p>
					</div>
					<div class="pic1"><img src="../../../images/goods/insur_card/u1.jpg" width="20" />
						<br/>消费者保障服务</div>
					<div class="pic1"><img src="../../../images/goods/insur_card/u1.jpg" width="20" />
						<br/>消费者保障服务</div>
					<div class="pic2"><img src="../../../images/goods/insur_card/jj.png" width="25" /></div>
					<div style="clear:both;"></div>
				</div>
				<div class="xmain">
					<div class="xuanz-fl" style="display: none;">
						<strong>卡单保障</strong>
						<p>{{value.summary}}</p>
					</div>
					<div class="xuanz-sl">
						<strong>数量:</strong>
						<h3><input type="button" value="-" class="slsl" id="reducebt" ><input value="1" class="slsloo" id="productNum"><input type="button" value="+" class="slsl" id="addbt"></h3>
						<div style="clear:both;"></div>
					</div>
				</div>
				<div class="xmain">
					<div class="xuanz-cp">
						<strong>卡单简介</strong>
						<p><strong>提供商</strong>{{value.product__supplier__title}}</p>
						<p><strong>保险分类</strong>{{value.card_cate}}</p>
						<p><strong>种类</strong>保险卡单</p>
						<p><strong>激活</strong>自主激活，线上激活</p>
						<p><strong>投保要求</strong>{{value.conditions}}</p>
						<div id="textinfo">
							
						</div>
						<div style="clear:both;"></div>
					</div>
				</div>
				<div class="xmain">
					<div class="xuanz-xq">
						
						<div style="clear:both;"></div>
					</div>
				</div>
			{{/each}}
		</script>
		<!--<ul class="" id="mui-table-content">
							<li class="">
								<a class="" >产品详情</a>
								<div class="">
									<p>产品详情1</p>
								</div>
							</li>
							<li class="">
								<a >投保范围</a>
								<div class="">
									<p>{{value.card_range}}</p>
								</div>
							</li>
							<li class="">
								<a >投保须知</a>
								<div class="">
									<p>{{value.info}} </p>
								</div>
							</li>
							<li class="">
								<a class="">售后服务</a>
								<div class="">
									<p>{{value.after_sale_service}}</p>
								</div>
							</li>
							<li class="">
								<a class="" >保单形式</a>
								<div class="">
									<p>{{value.form_detail}}</p>
								</div>
							</li>
						</ul>-->
		
		<script type="text/javascript" src="../../../js/mui.min.js" ></script>
		<script type="text/javascript" src="../../../js/template.js" ></script>
		<script src="../../../js/app.js" type="text/javascript" charset="utf-8"></script>
		<script src="../../../js/jquery-2.1.3.min.js" type="text/javascript" charset="utf-8"></script>
		<script type="text/javascript">
			mui.init();
			mui.plusReady(function(){
//				document.getElementById("buying").addEventListener('tap',function(){
//					mui.openWindow('insur_card_cart.html','insur_card_cart');
//				});
				var self = plus.webview.currentWebview();
				product_id = self.product_id;
				console.log("当前页面产品id: " + product_id);

				getInsurCard(product_id);
			});


			//获取卡单展示列表
			function getInsurCard(product_id) {
				var settings = app.getSettings();
				var webServiceUrl = settings.webServiceUrl;
				var imgUrl = settings.imgUrl;
				plus.nativeUI.toast("当前服务器地址为："+ webServiceUrl);
				
//				url: "http://www.annpeter.cn:8080/app/kadan/profile?id=productID"
// 				url: "../../../json/goods/insur_card/card_info.json"

				mui.ajax({
					url: webServiceUrl + "/app/kadan/profile?id=" + product_id,
					type: "post",
					async: true,
					data: {
					},
					dataType: "json",
					timeout: 1000,
					success: function(data) {
						if(data.status == 1){
							console.log("卡单详情ajax请求成功");
							var cardInfoList = document.getElementById("cardInfoList");
							
							//循环遍历result数组，给数组中 img_big 添加 url 头属性
							for(var i = 0; i < data.result.length; i++){
								data.result[i].img_big = imgUrl + data.result[i].img_big;
	//							console.log(data.result[i].img_big);
							}
							
							var content = template("cardInfoTmpl", data);
							cardInfoList.innerHTML = content;
							
							var textinfo = document.getElementById("textinfo");
							var textinfoContent = data.result[0].textinfo;
							textinfo.innerHTML = textinfoContent;
							
							// 由于我们是异步执行，所以在html部分拼接完成之后，才能对其进行添加点击事件的操作；
							addNumListener();
	//						settlementPrice(1);
							
							addToShopCartListener();
							//立即购买，前往购物车
							toShopCartListener();
						}else{
							plus.nativeUI.toast("网络好像暂时不通畅哦，请重新加载页面");
						}
					},
					error:function(xhr,type,errorThrown){
						//异常处理
						plus.nativeUI.toast("网络好像暂时不通畅哦，请重新加载页面");
						console.log(type);
					}
				});
			};
			function addNumListener(){
				var addButton = document.getElementById("addbt");
				var reduceButton = document.getElementById("reducebt");
				addButton.addEventListener('tap',addNum);
				reduceButton.addEventListener('tap',reduceNum);
			}
			function addNum(){ 
//				plus.nativeUI.toast("addNum");
				var productNum = document.getElementById("productNum");
				num = parseInt(productNum.value);
				if(num >= 0 && num < 10){
					num = num + 1;
				}else if(num != 0 || num != 10){
					num = 10;
				}
				productNum.value = num;
			}
			function reduceNum(){ 
				var productNum = document.getElementById("productNum");
				num = parseInt(productNum.value);
				if(num > 0 && num <= 10){
					num = num - 1;
				}else if(num != 0 || num != 10){
					num = 0;
				}
				productNum.value = num;
			}
			
			function settlementPrice(totalPrice) { //结算
				var productNum = document.getElementById("productNum");
				var idInfo = document.getElementById("idInfo");
//				console.log(productNum.value);
				
				var productArray = [];
				// 将个数不为0的商品信息，添加到数组中
				
				if (productNum.value != "0") {
					var productDetail = idInfo.getAttribute("data-id");
					var productObj = JSON.parse(productDetail);
					// 将商品的数量添加到商品对象中
					productObj["productNum"] = productNum.value;
					productArray.push(productObj);
				}
//				plus.nativeUI.toast(productArray);
//				mui.openWindow({
//					url: "../order/userOrder.html",
//					id: "userOrder",
//					waiting: {
//						autoShow: false
//					},
//					extras: {
//						productList: productArray,
//						totalPrice: totalPrice
//					}//将商品列表信息和总价格，一起传递到下一个窗口
//				});
			}
			
			//加入购物车
			function addToShopCartListener(){
				/**
				 * 这里ajax请求的是一个本地json文件
				 * 实际项目调用接口只需要将url地址替换成接口地址即可
				 */
				var addtoCart = document.getElementById("addtoCart");
				addtoCart.addEventListener('tap',function(){
					var productNum = document.getElementById("productNum").value;
					var state = app.getState();
					uid = state.uid;
					
					var settings = app.getSettings();
					var webServiceUrl = settings.webServiceUrl;
					
					console.log("userid:" + uid);
					console.log("productid:" + product_id);
					console.log("num:" + document.getElementById("productNum").value);
					
					var jsObj = {
	                	"member_id":uid,
	                	"jsonShoppingCartModifies":[
							{"id":product_id, "num":productNum},
						]
	            	};
    				var str = JSON.stringify(jsObj);
    				
    				//url: "../../../json/goods/insur_card/product_change_return.json"
    				///app/shoppingcart/modify
					mui.ajax({
						url: webServiceUrl + "app/shoppingcart/modify",
						type: "post",
						async: true,
						data: {"reqJsonStr":str},
						dataType: "json",
						timeout: 1000,
						success: function(data) {
							if(data.status == 1){
								plus.nativeUI.toast("已成功加入购物车");
							}else{
								plus.nativeUI.toast("加入购物车失败");
							}
						},
						error:function(xhr,type,errorThrown){
							//异常处理
							plus.nativeUI.toast("网络不通畅，请检查网络状态重试");
							console.log(type);
						}
					});
				});
			}
			
			//前往购物车
			function toShopCartListener(){
				var buyingButton = document.getElementById("buying");
				buyingButton.addEventListener('tap',function(){
					mui.openWindow('insur_card_cart.html','insur_card_cart');
				});
			}
		</script>
	</body>

</html>